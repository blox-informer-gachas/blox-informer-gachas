<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Forge Crafting Calculator & Simulator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #FF6600;
            --primary-dark: #cc5200;
            --primary-light: rgba(255, 102, 0, 0.1);
            --primary-glow: rgba(255, 102, 0, 0.3);
            --background: #0f0f0f;
            --card-bg: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --text: #f0f0f0;
            --text-secondary: #ffa366;
            --border: #444;
            --success: #4CAF50;
            --warning: #ff9800;
            --error: #f44336;
            --glow: 0 0 15px rgba(255, 102, 0, 0.4);
            --common: #8c8c8c;
            --uncommon: #4CAF50;
            --rare: #2196F3;
            --epic: #9c27b0;
            --legendary: #f0b209;
            --mythical: #d13429;
            --relic: #ffeb3b;
            --stonewake-teal: #0a6e6e;
            --animation-speed: 0.3s;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            max-width: 840px;
            margin: 0 auto;
            padding: 10px;
            line-height: 1.6;
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 20% 80%, var(--primary-light) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--primary-light) 0%, transparent 50%);
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Header & Mode Toggle */
        header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--border-radius);
            box-shadow: var(--glow);
            position: relative;
            overflow: hidden;
            animation: slideDown 0.5s ease-out;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 3s infinite;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 25%;
            width: 50%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        /* Buttons */
        button {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all var(--animation-speed) cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: none;
            cursor: pointer;
            outline: none;
        }

        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        .toggle-btn {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--text);
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.95rem;
            border: 2px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, var(--text-secondary), var(--primary-dark));
            border-color: rgba(255, 255, 255, 0.2);
        }

        .toggle-btn:hover:not(.active) {
            box-shadow: 0px 6px 20px rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary);
            transform: translateY(-3px);
        }

        /* Quick Craft Button */
        .quick-craft-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }

        .quick-craft-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px var(--primary-glow);
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn var(--animation-speed) ease-out;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
            border: 2px solid var(--primary-dark);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-dark);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.6rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--animation-speed);
            position: relative;
        }

        .modal-close:hover {
            background: var(--primary-dark);
            transform: rotate(90deg);
        }

        .modal-step {
            margin-bottom: 15px;
            display: none;
        }

        .modal-step.active {
            display: block;
        }

        .modal-step-title {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .modal-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-option {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-option.selected {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }

        .modal-option:hover {
            transform: translateY(-3px);
        }

        .trait-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            transform-origin: center;
        }

        .trait-option:hover {
            transform: translateY(-3px);
            border-color: var(--primary-light);
            background-color: var(--primary-light);
        }

        .trait-option.selected {
            border-color: var(--primary);
            background-color: var(--primary-light);
            box-shadow: 0 0 10px var(--primary-light);
        }

        .trait-option.selected:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
        }

        .trait-info {
            flex: 1;
            text-align: left;
        }

        .trait-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text);
        }

        .trait-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
            line-height: 1.4;
        }

        .modal-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }

        /* Sections */
        .inventory-section,
        .mix-section,
        .probability-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeInUp 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .inventory-section::before,
        .mix-section::before,
        .probability-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), transparent);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title i {
            margin-right: 6px;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            transition: all var(--animation-speed);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .filter-btn:hover:not(.active) {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Ores Grid */
        .ores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            min-height: 235px;
            max-height: 235px;
            overflow-y: auto;
            padding: 10px;
        }

        .ore-item {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
            aspect-ratio: 232/173;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .ore-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .ore-item.has-trait .trait-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--primary);
            font-size: 1rem;
            text-shadow: 0 0 5px var(--primary-glow);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .ore-item.has-trait .trait-indicator i {
            font-size: 1rem;
        }

        .ore-name {
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.95rem;
            font-weight: bold;
            padding: 3px 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ore-multiplier {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        .ore-item.no-image {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            position: relative;
            overflow: hidden;
        }

        .ore-item.no-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.03) 0%,
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.1) 100%);
            z-index: 1;
        }

        .ore-item.no-image::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(45deg, rgba(255, 255, 255, 0.02) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.02) 50%, rgba(255, 255, 255, 0.02) 75%, transparent 75%, transparent);
            background-size: 8px 8px;
            z-index: 0;
        }

        .ore-item.no-image .ore-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            opacity: 0.7;
            z-index: 1;
        }

        .ore-item.no-image .ore-name {
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.95rem;
            font-weight: bold;
            padding: 3px 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .ore-item.no-image .ore-multiplier {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        /* Slots */
        .slots-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .slot {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            text-align: center;
            border: 2px dashed var(--border);
            transition: all 0.3s;
            aspect-ratio: 232/173;
            position: relative;
            overflow: hidden;
        }

        .slot.filled {
            border: 2px solid var(--primary);
            background-color: var(--primary-light);
            transition: all 0.3s ease;
        }

        .slot.filled:hover {
            box-shadow: var(--glow);
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }

        .slot-placeholder {
            color: var(--border);
            font-size: 0.9rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .slot-ore {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        .slot-ore-name {
            position: absolute;
            top: 8px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            padding: 3px 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slot-ore-count {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        .slot-ore-percentage {
            position: absolute;
            bottom: 8px;
            left: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8),
                -1px -1px 0 rgba(0, 0, 0, 0.5),
                1px -1px 0 rgba(0, 0, 0, 0.5),
                -1px 1px 0 rgba(0, 0, 0, 0.5),
                1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        /* Stats & Traits */
        .stat-box {
            background: linear-gradient(135deg, var(--primary-light), rgba(0, 0, 0, 0.2));
            border-radius: var(--border-radius);
            padding: 5px;
            text-align: center;
            border: 1px solid var(--primary-light);
            backdrop-filter: blur(10px);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border: 1px solid var(--primary);
            transition: all 0.3s ease;
        }

        .stat-title {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        /* Traits Section */
        .traits-container {
            margin-top: 10px;
        }

        .traits-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .trait-card {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all var(--animation-speed) ease;
            position: relative;
            overflow: hidden;
        }

        .trait-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-light), transparent);
            opacity: 0;
            transition: opacity var(--animation-speed) ease;
        }

        .trait-card:hover::before {
            opacity: 1;
        }

        .trait-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow);
        }

        .trait-content {
            flex: 1;
        }

        .trait-name {
            font-weight: bold;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trait-percentage {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: var(--border-radius);
        }

        .trait-description {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.4;
        }

        /* Probability Section */
        .probability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .probability-item {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), var(--primary-light));
            border-radius: 10px;
            padding: 10px 15px;
            border: 2px solid var(--primary-light);
            border-left: 4px solid var(--primary);
            transition: all var(--animation-speed);
            backdrop-filter: blur(10px);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2);
        }

        .probability-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-light), transparent);
            opacity: 0;
            transition: opacity var(--animation-speed) ease;
        }

        .probability-item:hover::before {
            opacity: 1;
        }

        .probability-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: bold;
            font-size: 0.95rem;
            color: var(--text);
            flex: 1;
        }

        .optimal-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: var(--border-radius);
            font-weight: 600;
            white-space: nowrap;
            margin-left: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .probability-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--text-secondary));
            border-radius: 12px;
            position: relative;
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-width: 0;
        }

        .probability-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .probability-value {
            position: absolute;
            top: 0;
            right: 10px;
            font-size: 0.80rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            line-height: 24px;
            z-index: 2;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s;
        }

        .control-btn:hover::before {
            left: 100%;
        }

        .forge-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 6px 25px var(--primary-light);
        }

        .forge-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px var(--primary-glow);
        }

        .reset-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--primary);
        }

        /* Forge Result Modal */
        .forge-result-container {
            padding: 15px 10px;
            border-radius: var(--border-radius);
        }

        #forge-result-content {
            max-width: 700px;
            animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .forge-result-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .forge-result-image {
            width: 140px;
            height: 105px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            border: 3px solid;
            box-shadow: 0 0 25px;
            flex-shrink: 0;
        }

        .forge-result-details {
            flex: 1;
            min-width: 250px;
        }

        .forge-result-name {
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .forge-result-type {
            font-size: 1rem;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .forge-result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .forge-tag {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.80rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
        }

        .forge-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .forge-stat-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid var(--primary-light);
            backdrop-filter: blur(10px);
            text-align: center;
            transition: all var(--animation-speed) ease;
        }

        .forge-stat-item:hover {
            background: rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
            box-shadow: var(--glow);
            transform: translateY(-3px);
            transition: all var(--animation-speed) ease;
        }

        .forge-stat-label {
            color: var(--text);
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .forge-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .traits-section {
            margin-top: 10px;
        }

        .traits-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .trait-placeholder {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .forge-trait-item {
            background: linear-gradient(135deg, var(--primary-glow), var(--primary-light));
            border: 1px solid var(--primary-light);
            border-radius: 10px;
            padding: 10px 15px;
            backdrop-filter: blur(10px);
            transition: all var(--animation-speed);
        }

        .forge-trait-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--primary-glow);
        }

        .forge-trait-ore {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }

        .forge-trait-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Area Toggle */
        .area-toggle-btn {
            font-size: 0.85rem;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--animation-speed);
            font-weight: 600;
        }

        .area-toggle-btn.kingdom {
            background: linear-gradient(135deg, #FF6600, #cc5200);
            border-color: var(--primary);
            color: white;
        }

        .area-toggle-btn.stonewake {
            background: linear-gradient(135deg, #1da5a5, #084e4e);
            border-color: var(--stonewake-teal);
            color: white;
        }

        .area-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        /* Tooltip */
        .tooltip {
            display: none;
            position: fixed;
            background-color: #1d1d1d;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            z-index: 1001;
            max-width: 300px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .tooltip-title {
            font-size: 1rem;
            color: var(--primary);
            margin: 0;
        }

        .tooltip-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .variant-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .variant-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variant-name {
            font-weight: bold;
        }

        .variant-chance {
            color: var(--primary);
            font-weight: bold;
            background-color: var(--primary-light);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .step-panel {
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s ease;
        }

        .step-panel.active {
            opacity: 1;
            pointer-events: auto;
        }

        .step-anim-in {
            animation: fadeIn .3s ease forwards;
        }

        .step-anim-out {
            animation: fadeOut .3s ease forwards;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }


        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }

            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }

            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {

            .forge-result-tags {
                justify-content: center;
            }

            .forge-tag {
                font-size: 0.75rem;
                padding: 5px 12px;
            }

            .forge-result-header {
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }

            .forge-stat-value {
                font-size: 1.2rem;
            }

            h1 {
                font-size: 1.4rem;
            }

            .stat-value {
                font-size: 1.6rem;
            }


        }

        @media (max-width: 480px) {
            body.modal-open {
                position: fixed;
                overflow: hidden;
                width: 100%;
                height: 100%;
            }

            .traits-grid {
                grid-template-columns: 1fr;
            }

            .slots-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .ores-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .probability-grid {
                grid-template-columns: 1fr;
            }

            .filter-controls {
                justify-content: center;
            }

        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        }

        /* Rarity Colors */
        .common {
            border-color: var(--common);
        }

        .uncommon {
            border-color: var(--uncommon);
        }

        .rare {
            border-color: var(--rare);
        }

        .epic {
            border-color: var(--epic);
        }

        .legendary {
            border-color: var(--legendary);
            border-image: var(--legendary) 1;
        }

        .mythical {
            border-color: var(--mythical);
            border-image: var(--mythical) 1;
        }

        .relic {
            border-color: var(--relic);
            border-image: var(--relic) 1;
        }

        .common .ore-name {
            color: var(--common);
        }

        .uncommon .ore-name {
            color: var(--uncommon);
        }

        .rare .ore-name {
            color: var(--rare);
        }

        .epic .ore-name {
            color: var(--epic);
        }

        .legendary .ore-name {
            color: var(--legendary);
        }

        .mythical .ore-name {
            color: var(--mythical);
        }

        .relic .ore-name {
            color: var(--relic);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hammer"></i> The Forge Crafting Calculator</h1>

            <div class="mode-toggle">
                <button class="toggle-btn active" id="weapon-toggle">
                    &#9876; Weapons
                </button>
                <button class="toggle-btn" id="armor-toggle">
                    <i class="fas fa-shield-alt" style="font-size: 0.8rem;"></i> Armor
                </button>
            </div>


        </header>

        <div class="modal-overlay" id="quick-craft-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-bolt"></i> Quick Craft</h3>
                    <button class="modal-close" id="modal-close">&times;</button>
                </div>

                <div class="modal-step active step-panel" id="step-type">
                    <div class="modal-step-title">1. Select Item Type</div>
                    <div class="modal-options">
                        <div class="modal-option" data-type="weapon" style="display: flex; flex-direction: column;">
                            <span style="font-size: 36px; margin-top: -15px; margin-bottom: -5px;">&#9876;</span>
                            <div>Weapons</div>
                        </div>
                        <div class="modal-option" data-type="armor">
                            <i class="fas fa-shield-alt fa-2x"></i>
                            <div>Armor</div>
                        </div>
                    </div>
                </div>

                <div class="modal-step step-panel" id="step-item">
                    <div class="modal-step-title">2. Select Item</div>
                    <div class="modal-options" id="item-options">
                    </div>
                </div>

                <div class="modal-step step-panel" id="step-traits">
                    <div class="modal-step-title">3. Select Traits (Max 4)</div>
                    <div id="trait-options">
                    </div>
                    <div id="selected-traits-count" style="margin-top: 10px; color: var(--text-secondary);">
                        Selected: 0/4 traits
                    </div>
                </div>

                <div class="modal-step step-panel" id="step-summary">
                    <div class="modal-step-title">4. Summary</div>
                    <div id="summary-content" style="background-color: rgba(0,0,0,0.2); border-radius: 8px;">
                    </div>
                </div>

                <div class="modal-nav">
                    <button class="control-btn reset-btn" id="prev-btn">Previous</button>
                    <button class="control-btn forge-btn" id="next-btn">Next</button>
                    <button class="control-btn forge-btn" id="craft-btn" style="display: none;">Craft Item</button>
                </div>
            </div>
        </div>

        <section class="inventory-section">
            <div class="section-title">
                <span><i class="fas fa-gem"></i> Ore List / Select Ores</span>
            </div>

            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">All Ores</button>
                <button class="filter-btn" data-filter="stonewake">Stonewake's Cross</button>
                <button class="filter-btn" data-filter="kingdom">Forgotten Kingdom</button>
                <button class="filter-btn" data-filter="goblin">Goblin Cave</button>
                <button class="filter-btn" data-filter="enemy">Enemy Drops</button>
                <button class="filter-btn" data-filter="has-trait">With Traits</button>
                <button class="filter-btn" data-filter="has-weapon-trait">With Weapon Traits</button>
                <button class="filter-btn" data-filter="has-armor-trait">With Armor Traits</button>
            </div>

            <div class="ores-grid" id="ore-inventory">
            </div>
        </section>

        <section class="mix-section">
            <div class="section-title">
                <span><i class="fas fa-fire"></i> Forge</span>
                <button class="quick-craft-btn" id="quick-craft-btn">
                    <i class="fas fa-bolt"></i> Quick Craft
                </button>
            </div>

            <div class="slots-container" id="ore-slots">
                <div class="slot" id="slot-1">
                    <div class="slot-placeholder">Click an ore to add</div>
                </div>
                <div class="slot" id="slot-2">
                    <div class="slot-placeholder">Empty slot</div>
                </div>
                <div class="slot" id="slot-3">
                    <div class="slot-placeholder">Empty slot</div>
                </div>
                <div class="slot" id="slot-4">
                    <div class="slot-placeholder">Empty slot</div>
                </div>
            </div>

            <div class="mix-stats">
                <div class="stat-box">
                    <div class="stat-value" id="multiplier-value">0.0x</div>
                    <div class="stat-title" id="expected-item" style="color: var(--success)">Expected: None (0%)</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;" class="controls">
                <button class="control-btn forge-btn" id="forge-btn">
                    <i class="fas fa-fire"></i> Forge Item
                </button>
                <button class="control-btn reset-btn" id="reset-btn">
                    <i class="fas fa-redo"></i> Reset Forge
                </button>

            </div>
            <div class="traits-container">
                <div class="section-title">
                    <span><i class="fas fa-magic"></i> Ore Traits</span>
                </div>
                <div class="traits-grid" id="active-traits">
                    <div class="trait-placeholder">Add ores with traits to see effects...</div>
                </div>
            </div>
        </section>

        <section class="probability-section">
            <div class="section-title">
                <span><i class="fas fa-chart-pie"></i> Forge Chances</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="area-toggle-btn" id="area-toggle-btn"
                        style="font-size: 0.8rem; padding: 5px 12px; border-radius: 15px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <i class="fas fa-map-marker-alt"></i> <span id="area-label">Forgotten Kingdom</span>
                    </button>
                </div>

            </div>
            <div class="probability-grid" id="probability-list"></div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px; text-align: center;">(Click
                on an item type for specific item forge odds)</div>
    </div>

    <div class="tooltip" id="variant-tooltip">
        <div class="tooltip-header">
            <h3 class="tooltip-title" id="tooltip-item-name">Item Variants</h3>
            <button class="modal-close" id="tooltip-close">&times;</button>
        </div>
        <div class="tooltip-content" id="tooltip-content">
        </div>
    </div>
    </section>
    <div class="modal-overlay" id="forge-result-modal">
        <div class="modal-content" id="forge-result-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-fire"></i> Forged Item</h3>
                <button class="modal-close" id="forge-result-close">&times;</button>
            </div>
            <div id="forge-result-body">
            </div>
            <div class="modal-nav" style="justify-content: center; margin-top: 15px;">
                <button class="control-btn forge-btn" id="forge-again-btn">Forge Again</button>
                <button class="control-btn reset-btn" id="close-result-btn">Close</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        const oreImages = {
            "Stone": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/stone-the-forge-calculator.png",
            "Sand Stone": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/sand-stone-the-forge-calculator.png",
            "Copper": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/copper-the-forge-calculator.png",
            "Iron": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/iron-the-forge-calculator.png",
            "Tin": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/tin-the-forge-calculator.png",
            "Silver": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/silver-the-forge-calculator.png",
            "Gold": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/gold-the-forge-calculator.png",
            "Mushroomite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/mushroomite-the-forge-calculator.png",
            "Platinum": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/platinum-the-forge-calculator.png",
            "Bananite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/bananite-the-forge-calculator.png",
            "Cardboardite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/carboardite-the-forge-calculator.png",
            "Aite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/aite-the-forge-calculator.png",
            "Poopite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/poopite-the-forge-calculator.png",
            "Cobalt": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/cobalt-the-forge-calculator.png",
            "Titanium": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/titanium-the-forge-calculator.png",
            "Volcanic Rock": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/volcanic-rock-the-forge-calculator.png",
            "Lapis Lazuli": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/lapis-lazuli-the-forge-calculator.png",
            "Quartz": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/quartz-the-forge-calculator.png",
            "Amethyst": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/amethyst-the-forge-calculator.png",
            "Topaz": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/topaz-the-forge-calculator.png",
            "Diamond": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/diamond-the-forge-calculator.png",
            "Sapphire": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/sapphire-the-forge-calculator.png",
            "Cuprite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/cuprite-the-forge-calculator.png",
            "Obsidian": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/obsidian-the-forge-calculator.png",
            "Emerald": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/emerald-the-forge-calculator.png",
            "Ruby": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/ruby-the-forge-calculator.png",
            "Rivalite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/rivalite-the-forge-calculator.png",
            "Uranium": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/uranium-the-forge-calculator.png",
            "Mythril": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/mythril-the-forge-calculator.png",
            "Eye Ore": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/eye-ore-the-forge-calculator.png",
            "Fireite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/fireite-the-forge-calculator.png",
            "Magmaite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/magmaite-the-forge-calculator.png",
            "Lightite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/lightite-the-forge-calculator.png",
            "Demonite": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/demonite-the-forge-calculator.png",
            "Darkryte": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/darkryte-the-forge-calculator.png",
            "Magenta Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/magenta-crystal-the-forge-calculator.png",
            "Crimson Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/crimson-crystal-the-forge-calculator.png",
            "Green Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/green-crystal-the-forge-calculator.png",
            "Orange Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/orange-crystal-the-forge-calculator.png",
            "Blue Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/blue-crystal-the-forge-calculator.png",
            "Rainbow Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/rainbow-crystal-the-forge-calculator.png",
            "Arcane Crystal": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/arcane-crystal-the-forge-calculator.png"
        };

        const itemImages = {
            // Daggers
            "Dagger": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/dagger-the-forge-calculator.png",
            "Falchion Knife": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/falchion-knife-the-forge-calculator.png",
            "Gladius Dagger": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/gladius-dagger-the-forge-calculator.png",
            "Hook": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/hook-the-forge-calculator.png",

            // Straight Swords
            "Falchion": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/falchion-the-forge-calculator.png",
            "Gladius": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/gladius-the-forge-calculator.png",
            "Cutlass": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/cutlass-the-forge-calculator.png",
            "Rapier": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/rapier-the-forge-calculator.png",
            "Chaos": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/chaos-the-forge-calculator.png",

            // Gauntlets
            "Ironhand": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/ironhand-the-forge-calculator.png",
            "Boxing Gloves": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/boxing-gloves-the-forge-calculator.png",
            "Relevator": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/relevator-the-forge-calculator.png",

            // Katanas
            "Uchigatana": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/uchigatana-the-forge-calculator.png",
            "Tachi": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/tachi-the-forge-calculator.png",

            // Great Swords
            "Crusader Sword": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/crusader-sword-the-forge-calculator.png",
            "Long Sword": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/long-sword-the-forge-calculator.png",

            // Great Axes
            "Scythe": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/scythe-the-forge-calculator.png",
            "Double Battle Axe": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/double-battle-axe-the-forge-calculator.png",

            // Colossal Swords
            "Great Sword": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/great-sword-the-forge-calculator.png",
            "Dragon Slayer": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/dragon-slayer-the-forge-calculator.png",
            "Hammer": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/hammer-the-forge-calculator.png",
            "Skull Crusher": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/skull-crusher-the-forge-calculator.png",
            "Comically Large Spoon": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/comically-large-spoon-the-forge-calculator.png",

            // Light Armor
            "Light Helmet": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/light-helmet-the-forge-calculator.png",
            "Light Leggings": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/light-leggings-the-forge-calculator.png",
            "Light Chestplate": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/light-chestplate-the-forge-calculator.png",

            // Medium Armor
            "Medium Helmet": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/medium-helmet-the-forge-calculator.png",
            "Samurai Helmet": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/samurai-helmet-the-forge-calculator.png",
            "Medium Leggings": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/medium-leggings-the-forge-calculator.png",
            "Samurai Leggings": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/samurai-leggings-the-forge-calculator.png",
            "Medium Chestplate": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/medium-chestplate-the-forge-calculator.png",
            "Samurai Chestplate": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/samurai-chestplate-the-forge-calculator.png",

            // Heavy Armor
            "Knight Helmet": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/knight-helmet-the-forge-calculator.png",
            "Dark Knight Helmet": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/dark-knight-helmet-the-forge-calculator.png",
            "Knight Leggings": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/knight-leggings-the-forge-calculator.png",
            "Dark Knight Leggings": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/dark-knight-leggings-the-forge-calculator.png",
            "Knight Chestplate": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/knight-chestplate-the-forge-calculator.png",
            "Dark Knight Chestplate": "https://cms.bloxinformer.com/wp-content/uploads/2025/04/dark-knight-chestplate-the-forge-calculator.png"
        };

        const baseItemStats = {
            weapon: {
                "Dagger": { damage: 8.6, atkSpeed: 0.35, range: 6, price: 68, type: "Dagger" },
                "Falchion Knife": { damage: 8.6, atkSpeed: 0.35, range: 6, price: 68, type: "Dagger" },
                "Gladius Dagger": { damage: 8.6, atkSpeed: 0.35, range: 6, price: 68, type: "Dagger" },
                "Hook": { damage: 9.46, atkSpeed: 0.39, range: 6, price: 68, type: "Dagger" },

                "Falchion": { damage: 15, atkSpeed: 0.59, range: 8, price: 120, type: "Straight Sword" },
                "Gladius": { damage: 15.75, atkSpeed: 0.62, range: 8, price: 120, type: "Straight Sword" },
                "Cutlass": { damage: 18.75, atkSpeed: 0.66, range: 8, price: 120, type: "Straight Sword" },
                "Rapier": { damage: 15, atkSpeed: 0.49, range: 8, price: 120, type: "Straight Sword" },
                "Chaos": { damage: 18.75, atkSpeed: 0.59, range: 8, price: 120, type: "Straight Sword" },

                "Ironhand": { damage: 15.2, atkSpeed: 0.51, range: 6, price: 205, type: "Gauntlet" },
                "Boxing Gloves": { damage: 16, atkSpeed: 0.59, range: 6, price: 205, type: "Gauntlet" },
                "Relevator": { damage: 9.6, atkSpeed: 0.69, range: 6, price: 205, type: "Gauntlet" },

                "Uchigatana": { damage: 17, atkSpeed: 0.6, range: 9, price: 324, type: "Katana" },
                "Tachi": { damage: 17.85, atkSpeed: 0.63, range: 9, price: 324, type: "Katana" },

                "Crusader Sword": { damage: 24, atkSpeed: 1.0, range: 9, price: 485, type: "Great Sword" },
                "Long Sword": { damage: 24, atkSpeed: 1.11, range: 9, price: 485, type: "Great Sword" },

                "Scythe": { damage: 28.5, atkSpeed: 0.95, range: 9, price: 850, type: "Great Axe" },
                "Double Battle Axe": { damage: 31.5, atkSpeed: 1.05, range: 9, price: 850, type: "Great Axe" },

                "Great Sword": { damage: 40, atkSpeed: 1.12, range: 10, price: 1355, type: "Colossal Sword" },
                "Dragon Slayer": { damage: 44, atkSpeed: 1.12, range: 10, price: 1355, type: "Colossal Sword" },
                "Hammer": { damage: 44, atkSpeed: 1.24, range: 10, price: 1355, type: "Colossal Sword" },
                "Skull Crusher": { damage: 48, atkSpeed: 1.4, range: 10, price: 1355, type: "Colossal Sword" },
                "Comically Large Spoon": { damage: 36, atkSpeed: 1.12, range: 10, price: 1355, type: "Colossal Sword" }
            },
            armor: {
                "Light Helmet": { health: 3.75, price: 65, def: 8, type: "Light Helmet" },
                "Light Leggings": { health: 4.375, price: 112.5, def: 9, type: "Light Leggings" },
                "Light Chestplate": { health: 5, price: 225, def: 10, type: "Light Chestplate" },

                "Medium Helmet": { health: 6.25, price: 335, def: 12, type: "Medium Helmet" },
                "Samurai Helmet": { health: 8, price: 335, def: 16, type: "Medium Helmet" },
                "Medium Leggings": { health: 7.5, price: 485, def: 15, type: "Medium Leggings" },
                "Samurai Leggings": { health: 9, price: 485, def: 20, type: "Medium Leggings" },
                "Medium Chestplate": { health: 8.75, price: 850, def: 18, type: "Medium Chestplate" },
                "Samurai Chestplate": { health: 12.75, price: 850, def: 24, type: "Medium Chestplate" },

                "Knight Helmet": { health: 12.5, price: 1020, def: 24, type: "Heavy Helmet" },
                "Dark Knight Helmet": { health: 18.75, price: 1020, def: 38, type: "Heavy Helmet" },
                "Knight Leggings": { health: 13.75, price: 1200, def: 28, type: "Heavy Leggings" },
                "Dark Knight Leggings": { health: 21.875, price: 1200, def: 44, type: "Heavy Leggings" },
                "Knight Chestplate": { health: 16.25, price: 1355, def: 32, type: "Heavy Chestplate" },
                "Dark Knight Chestplate": { health: 25, price: 1355, def: 50, type: "Heavy Chestplate" }
            }
        };

        const oreData = [
            // Stonewake's Cross
            { id: 1, name: "Stone", multiplier: 0.2, rarity: "common", area: "stonewake", color: "#7b7773", traitType: null, traits: [] },
            { id: 2, name: "Sand Stone", multiplier: 0.25, rarity: "common", area: "stonewake", color: "#c3a777", traitType: null, traits: [] },
            { id: 3, name: "Copper", multiplier: 0.3, rarity: "common", area: "stonewake", color: "#925d3e", traitType: null, traits: [] },
            { id: 4, name: "Iron", multiplier: 0.35, rarity: "common", area: "stonewake", color: "#827356", traitType: null, traits: [] },
            { id: 5, name: "Tin", multiplier: 0.425, rarity: "uncommon", area: "stonewake", color: "#69707b", traitType: null, traits: [] },
            { id: 6, name: "Silver", multiplier: 0.5, rarity: "uncommon", area: "stonewake", color: "#bad0e0", traitType: null, traits: [] },
            { id: 7, name: "Gold", multiplier: 0.65, rarity: "uncommon", area: "stonewake", color: "#c89d40", traitType: null, traits: [] },
            { id: 8, name: "Mushroomite", multiplier: 0.8, rarity: "rare", area: "stonewake", color: "#9b8768", traitType: null, traits: [] },
            { id: 9, name: "Platinum", multiplier: 0.8, rarity: "rare", area: "stonewake", color: "#d6dee6", traitType: null, traits: [] },
            { id: 10, name: "Bananite", multiplier: 0.85, rarity: "uncommon", area: "stonewake", color: "#edbe70", traitType: null, traits: [] },
            { id: 11, name: "Cardboardite", multiplier: 0.7, rarity: "common", area: "stonewake", color: "#a28161", traitType: null, traits: [] },
            { id: 12, name: "Aite", multiplier: 1.0, rarity: "epic", area: "stonewake", color: "#f0d2a7", traitType: null, traits: [] },
            {
                id: 13, name: "Poopite", multiplier: 1.2, rarity: "epic", area: "stonewake", color: "#5f4937", traitType: "all", traits: [
                    {
                        description: "Deal {damage}% Poison DMG in AoE for {duration}s, fearing enemies (15s CD). Activates when HP drops below 35%.",
                        scaling: { damage: { min: 1.5, max: 15 }, duration: { min: 0.5, max: 5 } }, type: "all"
                    }
                ]
            },

            // Forgotten Kingdom
            { id: 14, name: "Cobalt", multiplier: 1.0, rarity: "uncommon", area: "kingdom", color: "#579de7", traitType: null, traits: [] },
            { id: 15, name: "Titanium", multiplier: 1.15, rarity: "uncommon", area: "kingdom", color: "#aca895", traitType: null, traits: [] },
            { id: 16, name: "Volcanic Rock", multiplier: 1.55, rarity: "rare", area: "kingdom", color: "#504b44", traitType: null, traits: [] },
            { id: 17, name: "Lapis Lazuli", multiplier: 1.3, rarity: "uncommon", area: "kingdom", color: "#5c89dc", traitType: null, traits: [] },
            { id: 18, name: "Quartz", multiplier: 1.5, rarity: "rare", area: "kingdom", color: "#a6babc", traitType: null, traits: [] },
            { id: 19, name: "Amethyst", multiplier: 1.65, rarity: "rare", area: "kingdom", color: "#a56bca", traitType: null, traits: [] },
            { id: 20, name: "Topaz", multiplier: 1.75, rarity: "rare", area: "kingdom", color: "#ffcc00", traitType: null, traits: [] },
            { id: 21, name: "Diamond", multiplier: 2.0, rarity: "rare", area: "kingdom", color: "#91cff0", traitType: null, traits: [] },
            { id: 22, name: "Sapphire", multiplier: 2.25, rarity: "rare", area: "kingdom", color: "#5194ec", traitType: null, traits: [] },
            { id: 23, name: "Cuprite", multiplier: 2.43, rarity: "epic", area: "kingdom", color: "#90af4a", traitType: null, traits: [] },
            {
                id: 24, name: "Obsidian", multiplier: 2.35, rarity: "epic", area: "kingdom", color: "#5b1fd5", traitType: "armor", traits: [
                    { description: "+{health}% extra health.", scaling: { health: { min: 3, max: 30 } }, type: "armor" }
                ]
            },
            { id: 25, name: "Emerald", multiplier: 2.55, rarity: "epic", area: "kingdom", color: "#8df356", traitType: null, traits: [] },
            { id: 26, name: "Ruby", multiplier: 2.95, rarity: "epic", area: "kingdom", color: "#ed4b4b", traitType: null, traits: [] },
            {
                id: 27, name: "Rivalite", multiplier: 3.33, rarity: "epic", area: "kingdom", color: "#f01919", traitType: "weapon", traits: [
                    { description: "+{crit}% critical chance.", scaling: { crit: { min: 2, max: 20 } }, type: "weapon" }
                ]
            },
            {
                id: 28, name: "Uranium", multiplier: 3.0, rarity: "legendary", area: "kingdom", color: "#8df060", traitType: "armor", traits: [
                    { description: "Deal {damage}% of max health as AoE DMG while in-combat.", scaling: { damage: { min: 0.5, max: 5 } }, type: "armor" }
                ]
            },
            {
                id: 29, name: "Mythril", multiplier: 3.5, rarity: "legendary", area: "kingdom", color: "#ad51ee", traitType: "armor", traits: [
                    { description: "+{health}% extra health.", scaling: { health: { min: 1.5, max: 15 } }, type: "armor" }
                ]
            },
            {
                id: 30, name: "Eye Ore", multiplier: 4.0, rarity: "legendary", area: "kingdom", color: "#d9681e", traitType: "all", traits: [
                    {
                        description: "Increase physical damage by +{damage}% and decrease health by -{health}%.",
                        scaling: { damage: { min: 1.5, max: 15 }, health: { min: 1, max: 10 } }, type: "all"
                    }
                ]
            },
            {
                id: 31, name: "Fireite", multiplier: 4.5, rarity: "legendary", area: "kingdom", color: "#d9670a", traitType: "weapon", traits: [
                    {
                        description: "Deals {damage}% of weapon damage as fire per second for 2 seconds. 30% chance on hit.",
                        scaling: { damage: { min: 2, max: 20 } }, type: "weapon"
                    }
                ]
            },
            {
                id: 32, name: "Magmaite", multiplier: 5.0, rarity: "legendary", area: "kingdom", color: "#db3d3d", traitType: "weapon", traits: [
                    {
                        description: "Cause an explosion on hit, dealing {damage}% of weapon damage as AoE damage. 35% chance on hit.",
                        scaling: { damage: { min: 5, max: 50 } }, type: "weapon"
                    }
                ]
            },
            {
                id: 33, name: "Lightite", multiplier: 4.6, rarity: "legendary", area: "kingdom", color: "#dfdfdf", traitType: "armor", traits: [
                    { description: "+{speed}% extra movement speed.", scaling: { speed: { min: 1.5, max: 15 } }, type: "armor" }
                ]
            },
            {
                id: 34, name: "Demonite", multiplier: 5.5, rarity: "mythical", area: "kingdom", color: "#901c1c", traitType: "armor", traits: [
                    {
                        description: "Deals {damage}% of weapon damage as fire per second for 2 seconds. 15% chance on hit and 25% chance when hit by an enemy.",
                        scaling: { damage: { min: 2, max: 20 } }, type: "armor"
                    }
                ]
            },
            {
                id: 35, name: "Darkryte", multiplier: 6.3, rarity: "mythical", area: "kingdom", color: "#dcdcdc", traitType: "armor", traits: [
                    {
                        description: "Upon taking damage, there is a {chance}% chance to turn into a shadow and dodge the attack.",
                        scaling: { chance: { min: 1.5, max: 15 } }, type: "armor"
                    }
                ]
            },

            // Goblin Cave
            { id: 36, name: "Magenta Crystal", multiplier: 3.1, rarity: "epic", area: "goblin", color: "#7d47a9", traitType: null, traits: [] },
            { id: 37, name: "Crimson Crystal", multiplier: 3.3, rarity: "epic", area: "goblin", color: "#dc143c", traitType: null, traits: [] },
            { id: 38, name: "Green Crystal", multiplier: 3.2, rarity: "epic", area: "goblin", color: "#8ba846", traitType: null, traits: [] },
            { id: 39, name: "Orange Crystal", multiplier: 3.0, rarity: "epic", area: "goblin", color: "#a66e41", traitType: null, traits: [] },
            { id: 40, name: "Blue Crystal", multiplier: 3.4, rarity: "epic", area: "goblin", color: "#A7C7E7", traitType: null, traits: [] },
            { id: 41, name: "Rainbow Crystal", multiplier: 5.25, rarity: "legendary", area: "goblin", color: "#50C878", traitType: null, traits: [] },
            { id: 42, name: "Arcane Crystal", multiplier: 7.5, rarity: "mythical", area: "goblin", color: "#d1e2f9", traitType: null, traits: [] },

            // Enemy Drops
            { id: 43, name: "Boneite", multiplier: 1.2, rarity: "rare", area: "enemy", color: "#f5f5dc", traitType: null, traits: [] },
            { id: 44, name: "Dark Boneite", multiplier: 2.25, rarity: "rare", area: "enemy", color: "#696969", traitType: null, traits: [] },
            { id: 45, name: "Slimite", multiplier: 2.25, rarity: "epic", area: "enemy", color: "#32cd32", traitType: null, traits: [] }
        ];

        // Weapon probability data
        const weaponProbabilities = {
            3: { "Dagger": 1.0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            4: { "Dagger": 0.86, "Straight Sword": 0.14, "Gauntlet": 0, "Katana": 0, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            5: { "Dagger": 0.35, "Straight Sword": 0.65, "Gauntlet": 0, "Katana": 0, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            6: { "Dagger": 0.14, "Straight Sword": 0.86, "Gauntlet": 0, "Katana": 0, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            7: { "Dagger": 0.06, "Straight Sword": 0.74, "Gauntlet": 0.2, "Katana": 0, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            8: { "Dagger": 0.02, "Straight Sword": 0.44, "Gauntlet": 0.54, "Katana": 0, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            9: { "Dagger": 0.01, "Straight Sword": 0.24, "Gauntlet": 0.65, "Katana": 0.1, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            10: { "Dagger": 0, "Straight Sword": 0.11, "Gauntlet": 0.47, "Katana": 0.42, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            11: { "Dagger": 0, "Straight Sword": 0.05, "Gauntlet": 0.32, "Katana": 0.63, "Great Sword": 0, "Great Axe": 0, "Colossal Sword": 0 },
            12: { "Dagger": 0, "Straight Sword": 0.03, "Gauntlet": 0.22, "Katana": 0.72, "Great Sword": 0.03, "Great Axe": 0, "Colossal Sword": 0 },
            13: { "Dagger": 0, "Straight Sword": 0.01, "Gauntlet": 0.15, "Katana": 0.62, "Great Sword": 0.22, "Great Axe": 0, "Colossal Sword": 0 },
            14: { "Dagger": 0, "Straight Sword": 0.01, "Gauntlet": 0.08, "Katana": 0.46, "Great Sword": 0.45, "Great Axe": 0, "Colossal Sword": 0 },
            15: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0.05, "Katana": 0.35, "Great Sword": 0.6, "Great Axe": 0, "Colossal Sword": 0 },
            16: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0.03, "Katana": 0.26, "Great Sword": 0.70, "Great Axe": 0.01, "Colossal Sword": 0 },
            17: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0.02, "Katana": 0.19, "Great Sword": 0.68, "Great Axe": 0.11, "Colossal Sword": 0 },
            18: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0.02, "Katana": 0.13, "Great Sword": 0.57, "Great Axe": 0.28, "Colossal Sword": 0 },
            19: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0.01, "Katana": 0.08, "Great Sword": 0.46, "Great Axe": 0.45, "Colossal Sword": 0 },
            20: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0.01, "Katana": 0.06, "Great Sword": 0.36, "Great Axe": 0.57, "Colossal Sword": 0 },
            21: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.04, "Great Sword": 0.29, "Great Axe": 0.65, "Colossal Sword": 0.02 },
            22: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.03, "Great Sword": 0.23, "Great Axe": 0.67, "Colossal Sword": 0.07 },
            23: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.02, "Great Sword": 0.19, "Great Axe": 0.66, "Colossal Sword": 0.13 },
            24: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.02, "Great Sword": 0.15, "Great Axe": 0.63, "Colossal Sword": 0.2 },
            25: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.01, "Great Sword": 0.12, "Great Axe": 0.6, "Colossal Sword": 0.27 },
            26: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.01, "Great Sword": 0.1, "Great Axe": 0.56, "Colossal Sword": 0.32 },
            27: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.01, "Great Sword": 0.09, "Great Axe": 0.53, "Colossal Sword": 0.37 },
            28: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.01, "Great Sword": 0.07, "Great Axe": 0.5, "Colossal Sword": 0.42 },
            29: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.01, "Great Sword": 0.07, "Great Axe": 0.47, "Colossal Sword": 0.46 },
            30: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0.01, "Great Sword": 0.06, "Great Axe": 0.45, "Colossal Sword": 0.49 },
            31: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.05, "Great Axe": 0.44, "Colossal Sword": 0.51 },
            32: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.05, "Great Axe": 0.41, "Colossal Sword": 0.54 },
            33: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.04, "Great Axe": 0.39, "Colossal Sword": 0.57 },
            34: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.04, "Great Axe": 0.38, "Colossal Sword": 0.58 },
            35: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.04, "Great Axe": 0.37, "Colossal Sword": 0.59 },
            36: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.36, "Colossal Sword": 0.61 },
            37: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.35, "Colossal Sword": 0.62 },
            38: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.34, "Colossal Sword": 0.63 },
            39: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.33, "Colossal Sword": 0.64 },
            40: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.32, "Colossal Sword": 0.65 },
            41: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.32, "Colossal Sword": 0.65 },
            42: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.03, "Great Axe": 0.31, "Colossal Sword": 0.66 },
            43: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.31, "Colossal Sword": 0.67 },
            44: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.3, "Colossal Sword": 0.68 },
            45: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.3, "Colossal Sword": 0.68 },
            46: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.29, "Colossal Sword": 0.69 },
            47: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.29, "Colossal Sword": 0.69 },
            48: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.28, "Colossal Sword": 0.7 },
            49: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.28, "Colossal Sword": 0.7 },
            50: { "Dagger": 0, "Straight Sword": 0, "Gauntlet": 0, "Katana": 0, "Great Sword": 0.02, "Great Axe": 0.28, "Colossal Sword": 0.7 }
        };
        // Armor probability data
        const armorProbabilities = {
            3: { "Light Helmet": 1.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            4: { "Light Helmet": 1.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            5: { "Light Helmet": 0.89, "Light Leggings": 0.11, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            6: { "Light Helmet": 0.56, "Light Leggings": 0.44, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            7: { "Light Helmet": 0.32, "Light Leggings": 0.67, "Light Chestplate": 0.01, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            8: { "Light Helmet": 0.16, "Light Leggings": 0.67, "Light Chestplate": 0.17, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            9: { "Light Helmet": 0.08, "Light Leggings": 0.51, "Light Chestplate": 0.41, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            10: { "Light Helmet": 0.04, "Light Leggings": 0.34, "Light Chestplate": 0.53, "Medium Helmet": 0.09, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            11: { "Light Helmet": 0.02, "Light Leggings": 0.2, "Light Chestplate": 0.47, "Medium Helmet": 0.31, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            12: { "Light Helmet": 0.01, "Light Leggings": 0.12, "Light Chestplate": 0.37, "Medium Helmet": 0.5, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            13: { "Light Helmet": 0, "Light Leggings": 0.07, "Light Chestplate": 0.28, "Medium Helmet": 0.6, "Medium Leggings": 0.04, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            14: { "Light Helmet": 0, "Light Leggings": 0.04, "Light Chestplate": 0.19, "Medium Helmet": 0.55, "Medium Leggings": 0.22, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            15: { "Light Helmet": 0, "Light Leggings": 0.02, "Light Chestplate": 0.12, "Medium Helmet": 0.43, "Medium Leggings": 0.43, "Medium Chestplate": 0, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            16: { "Light Helmet": 0, "Light Leggings": 0.01, "Light Chestplate": 0.08, "Medium Helmet": 0.32, "Medium Leggings": 0.57, "Medium Chestplate": 0.02, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            17: { "Light Helmet": 0, "Light Leggings": 0.01, "Light Chestplate": 0.05, "Medium Helmet": 0.22, "Medium Leggings": 0.57, "Medium Chestplate": 0.16, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            18: { "Light Helmet": 0, "Light Leggings": 0, "Light Chestplate": 0.03, "Medium Helmet": 0.14, "Medium Leggings": 0.48, "Medium Chestplate": 0.35, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            19: { "Light Helmet": 0, "Light Leggings": 0, "Light Chestplate": 0.02, "Medium Helmet": 0.09, "Medium Leggings": 0.39, "Medium Chestplate": 0.5, "Heavy Helmet": 0, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            20: { "Light Helmet": 0, "Light Leggings": 0, "Light Chestplate": 0.01, "Medium Helmet": 0.06, "Medium Leggings": 0.32, "Medium Chestplate": 0.6, "Heavy Helmet": 0.01, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            21: { "Light Helmet": 0, "Light Leggings": 0, "Light Chestplate": 0.01, "Medium Helmet": 0.04, "Medium Leggings": 0.25, "Medium Chestplate": 0.63, "Heavy Helmet": 0.07, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            22: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0.03, "Medium Leggings": 0.19, "Medium Chestplate": 0.59, "Heavy Helmet": 0.19, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            23: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0.02, "Medium Leggings": 0.14, "Medium Chestplate": 0.52, "Heavy Helmet": 0.32, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            24: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0.01, "Medium Leggings": 0.11, "Medium Chestplate": 0.44, "Heavy Helmet": 0.44, "Heavy Leggings": 0, "Heavy Chestplate": 0 },
            25: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0.01, "Medium Leggings": 0.07, "Medium Chestplate": 0.36, "Heavy Helmet": 0.51, "Heavy Leggings": 0.05, "Heavy Chestplate": 0 },
            26: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0.01, "Medium Leggings": 0.05, "Medium Chestplate": 0.28, "Heavy Helmet": 0.51, "Heavy Leggings": 0.15, "Heavy Chestplate": 0 },
            27: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0.04, "Medium Chestplate": 0.21, "Heavy Helmet": 0.47, "Heavy Leggings": 0.28, "Heavy Chestplate": 0 },
            28: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0.03, "Medium Chestplate": 0.16, "Heavy Helmet": 0.42, "Heavy Leggings": 0.39, "Heavy Chestplate": 0 },
            29: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0.02, "Medium Chestplate": 0.11, "Heavy Helmet": 0.35, "Heavy Leggings": 0.48, "Heavy Chestplate": 0.04 },
            30: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0.01, "Medium Chestplate": 0.08, "Heavy Helmet": 0.28, "Heavy Leggings": 0.50, "Heavy Chestplate": 0.13 },
            31: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0.01, "Medium Chestplate": 0.06, "Heavy Helmet": 0.22, "Heavy Leggings": 0.46, "Heavy Chestplate": 0.25 },
            32: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0.01, "Medium Chestplate": 0.04, "Heavy Helmet": 0.17, "Heavy Leggings": 0.42, "Heavy Chestplate": 0.36 },
            33: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.03, "Heavy Helmet": 0.13, "Heavy Leggings": 0.37, "Heavy Chestplate": 0.47 },
            34: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.02, "Heavy Helmet": 0.1, "Heavy Leggings": 0.33, "Heavy Chestplate": 0.55 },
            35: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.02, "Heavy Helmet": 0.08, "Heavy Leggings": 0.3, "Heavy Chestplate": 0.6 },
            36: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.01, "Heavy Helmet": 0.07, "Heavy Leggings": 0.27, "Heavy Chestplate": 0.65 },
            37: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.01, "Heavy Helmet": 0.06, "Heavy Leggings": 0.25, "Heavy Chestplate": 0.68 },
            38: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.01, "Heavy Helmet": 0.05, "Heavy Leggings": 0.23, "Heavy Chestplate": 0.71 },
            39: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.01, "Heavy Helmet": 0.04, "Heavy Leggings": 0.22, "Heavy Chestplate": 0.73 },
            40: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.01, "Heavy Helmet": 0.04, "Heavy Leggings": 0.2, "Heavy Chestplate": 0.75 },
            41: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0.01, "Heavy Helmet": 0.04, "Heavy Leggings": 0.19, "Heavy Chestplate": 0.77 },
            42: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.03, "Heavy Leggings": 0.18, "Heavy Chestplate": 0.79 },
            43: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.03, "Heavy Leggings": 0.17, "Heavy Chestplate": 0.8 },
            44: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.03, "Heavy Leggings": 0.17, "Heavy Chestplate": 0.8 },
            45: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.03, "Heavy Leggings": 0.16, "Heavy Chestplate": 0.81 },
            46: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.02, "Heavy Leggings": 0.16, "Heavy Chestplate": 0.82 },
            47: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.02, "Heavy Leggings": 0.15, "Heavy Chestplate": 0.83 },
            48: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.02, "Heavy Leggings": 0.15, "Heavy Chestplate": 0.83 },
            49: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.02, "Heavy Leggings": 0.14, "Heavy Chestplate": 0.84 },
            50: { "Light Helmet": 0.0, "Light Leggings": 0, "Light Chestplate": 0, "Medium Helmet": 0, "Medium Leggings": 0, "Medium Chestplate": 0, "Heavy Helmet": 0.02, "Heavy Leggings": 0.14, "Heavy Chestplate": 0.84 },
        };

        const specificItemVariants = {
            weapon: {
                "Dagger": {
                    "stonewake": [
                        { name: "Dagger", chance: "1/1", probability: 1.0 },
                        { name: "Falchion Knife", chance: "1/2", probability: 0.5 },
                        { name: "Gladius Dagger", chance: "1/16", probability: 0.0625 }
                    ],
                    "kingdom": [
                        { name: "Dagger", chance: "1/1", probability: 1.0 },
                        { name: "Gladius Dagger", chance: "1/4", probability: 0.25 },
                        { name: "Hook", chance: "1/16", probability: 0.0625 }
                    ]
                },
                "Straight Sword": {
                    "stonewake": [
                        { name: "Gladius", chance: "1/1", probability: 1.0 },
                        { name: "Falchion", chance: "1/3", probability: 0.3333 },
                        { name: "Cutlass", chance: "1/8", probability: 0.125 }
                    ],
                    "kingdom": [
                        { name: "Falchion", chance: "1/1", probability: 1.0 },
                        { name: "Cutlass", chance: "1/2", probability: 0.5 },
                        { name: "Rapier", chance: "1/4", probability: 0.25 },
                        { name: "Chaos", chance: "1/16", probability: 0.0625 }
                    ]
                },
                "Gauntlet": {
                    "stonewake": [
                        { name: "Ironhand", chance: "1/1", probability: 1.0 },
                        { name: "Boxing Gloves", chance: "1/4", probability: 0.25 }
                    ],
                    "kingdom": [
                        { name: "Ironhand", chance: "1/1", probability: 1.0 },
                        { name: "Relevator", chance: "1/4", probability: 0.25 }
                    ]
                },
                "Katana": {
                    "stonewake": [
                        { name: "Uchigatana", chance: "1/1", probability: 1.0 }
                    ],
                    "kingdom": [
                        { name: "Uchigatana", chance: "1/1", probability: 1.0 },
                        { name: "Tachi", chance: "1/4", probability: 0.25 }
                    ]
                },
                "Great Sword": {
                    "stonewake": [
                        { name: "Crusader Sword", chance: "1/1", probability: 1.0 }
                    ],
                    "kingdom": [
                        { name: "Crusader Sword", chance: "1/1", probability: 1.0 },
                        { name: "Long Sword", chance: "1/2", probability: 0.5 }
                    ]
                },
                "Great Axe": {
                    "stonewake": [
                        { name: "Double Battle Axe", chance: "1/1", probability: 1.0 }
                    ],
                    "kingdom": [
                        { name: "Double Battle Axe", chance: "1/1", probability: 1.0 },
                        { name: "Scythe", chance: "1/4", probability: 0.25 }
                    ]
                },
                "Colossal Sword": {
                    "stonewake": [
                        { name: "Great Sword", chance: "1/1", probability: 1.0 },
                        { name: "Hammer", chance: "1/4", probability: 0.25 },
                        { name: "Comically Large Spoon", chance: "1/16", probability: 0.0625 }
                    ],
                    "kingdom": [
                        { name: "Great Sword", chance: "1/1", probability: 1.0 },
                        { name: "Hammer", chance: "1/4", probability: 0.25 },
                        { name: "Skull Crusher", chance: "1/8", probability: 0.125 },
                        { name: "Dragon Slayer", chance: "1/16", probability: 0.0625 }
                    ]
                }
            },
            armor: {
                "Light Helmet": {
                    "stonewake": [{ name: "Light Helmet", chance: "1/1", probability: 1.0 }],
                    "kingdom": [{ name: "Light Helmet", chance: "1/1", probability: 1.0 }]
                },
                "Light Leggings": {
                    "stonewake": [{ name: "Light Leggings", chance: "1/1", probability: 1.0 }],
                    "kingdom": [{ name: "Light Leggings", chance: "1/1", probability: 1.0 }]
                },
                "Light Chestplate": {
                    "stonewake": [{ name: "Light Chestplate", chance: "1/1", probability: 1.0 }],
                    "kingdom": [{ name: "Light Chestplate", chance: "1/1", probability: 1.0 }]
                },
                "Medium Helmet": {
                    "stonewake": [{ name: "Medium Helmet", chance: "1/1", probability: 1.0 }],
                    "kingdom": [
                        { name: "Medium Helmet", chance: "1/1", probability: 1.0 },
                        { name: "Samurai Helmet", chance: "1/2", probability: 0.5 }
                    ]
                },
                "Medium Leggings": {
                    "stonewake": [{ name: "Medium Leggings", chance: "1/1", probability: 1.0 }],
                    "kingdom": [
                        { name: "Medium Leggings", chance: "1/1", probability: 1.0 },
                        { name: "Samurai Leggings", chance: "1/2", probability: 0.5 }
                    ]
                },
                "Medium Chestplate": {
                    "stonewake": [{ name: "Medium Chestplate", chance: "1/1", probability: 1.0 }],
                    "kingdom": [
                        { name: "Medium Chestplate", chance: "1/1", probability: 1.0 },
                        { name: "Samurai Chestplate", chance: "1/2", probability: 0.5 }
                    ]
                },
                "Heavy Helmet": {
                    "stonewake": [{ name: "Knight Helmet", chance: "1/1", probability: 1.0 }],
                    "kingdom": [
                        { name: "Knight Helmet", chance: "1/1", probability: 1.0 },
                        { name: "Dark Knight Helmet", chance: "1/2", probability: 0.5 }
                    ]
                },
                "Heavy Leggings": {
                    "stonewake": [{ name: "Knight Leggings", chance: "1/1", probability: 1.0 }],
                    "kingdom": [
                        { name: "Knight Leggings", chance: "1/1", probability: 1.0 },
                        { name: "Dark Knight Leggings", chance: "1/2", probability: 0.5 }
                    ]
                },
                "Heavy Chestplate": {
                    "stonewake": [{ name: "Knight Chestplate", chance: "1/1", probability: 1.0 }],
                    "kingdom": [
                        { name: "Knight Chestplate", chance: "1/1", probability: 1.0 },
                        { name: "Dark Knight Chestplate", chance: "1/2", probability: 0.5 }
                    ]
                }
            }
        };

        // Optimal ore counts for each item type
        const optimalCounts = {
            weapon: {
                "Dagger": 3,
                "Straight Sword": 6,
                "Gauntlet": 9,
                "Katana": 12,
                "Great Sword": 16,
                "Great Axe": 22,
                "Colossal Sword": 36
            },
            armor: {
                "Light Helmet": 3,
                "Light Leggings": 7,
                "Light Chestplate": 10,
                "Medium Helmet": 13,
                "Medium Leggings": 16,
                "Medium Chestplate": 21,
                "Heavy Helmet": 26,
                "Heavy Leggings": 30,
                "Heavy Chestplate": 40
            }
        };

        let currentMode = 'weapon';
        let oreMix = [];
        let activeFilter = 'all';

        let quickCraftType = null;
        let quickCraftItem = null;
        let selectedTraits = [];
        let currentStep = 0;
        let currentArea = 'kingdom';
        let highestProbabilityItem = null;

        const oreInventory = document.getElementById('ore-inventory');
        const oreSlotsContainer = document.getElementById('ore-slots');
        const probabilityList = document.getElementById('probability-list');
        const activeTraitsContainer = document.getElementById('active-traits');
        const multiplierValue = document.getElementById('multiplier-value');
        const totalOresDisplay = document.getElementById('total-ores');
        const weaponToggle = document.getElementById('weapon-toggle');
        const armorToggle = document.getElementById('armor-toggle');
        const resetBtn = document.getElementById('reset-btn');
        const forgeBtn = document.getElementById('forge-btn');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const quickCraftBtn = document.getElementById('quick-craft-btn');
        const quickCraftModal = document.getElementById('quick-craft-modal');
        const modalClose = document.getElementById('modal-close');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const craftBtn = document.getElementById('craft-btn');
        const stepType = document.getElementById('step-type');
        const stepItem = document.getElementById('step-item');
        const stepTraits = document.getElementById('step-traits');
        const stepSummary = document.getElementById('step-summary');
        const itemOptions = document.getElementById('item-options');
        const traitOptions = document.getElementById('trait-options');
        const selectedTraitsCount = document.getElementById('selected-traits-count');
        const summaryContent = document.getElementById('summary-content');

        function init() {
            renderOreInventory();
            updateOreSlots();
            updateProbabilities();
            setupEventListeners();
            setupQuickCraft();
            updateExpectedItem();
            updateAreaToggle();
            setupForgeResultModal();
        }

        document.getElementById('tooltip-close').addEventListener('click', () => {
            document.getElementById('variant-tooltip').style.display = 'none';
        });

        document.addEventListener('click', (e) => {
            const tooltip = document.getElementById('variant-tooltip');
            if (tooltip.style.display === 'block' && !tooltip.contains(e.target) && !e.target.closest('.probability-item')) {
                tooltip.style.display = 'none';
            }
        });

        function updateExpectedItem() {
            const totalOres = oreMix.reduce((sum, item) => sum + item.count, 0);
            const probabilities = currentMode === 'weapon' ? weaponProbabilities : armorProbabilities;
            const expectedItemEl = document.getElementById('expected-item');

            if (totalOres >= 3) {
                let closestCount = 3;
                if (totalOres >= 50) {
                    closestCount = 50;
                } else if (totalOres >= 3) {
                    const counts = Object.keys(probabilities).map(Number);
                    closestCount = counts.reduce((prev, curr) => {
                        return (Math.abs(curr - totalOres) < Math.abs(prev - totalOres) ? curr : prev);
                    });
                }

                const currentProbs = probabilities[closestCount] || {};
                let highestProb = 0;
                let highestItem = null;

                Object.entries(currentProbs).forEach(([itemName, probability]) => {
                    if (probability > highestProb) {
                        highestProb = probability;
                        highestItem = itemName;
                    }
                });

                highestProbabilityItem = highestItem;

                if (highestItem) {
                    const percent = (highestProb * 100).toFixed(1);
                    expectedItemEl.textContent = `Expected: ${highestItem} (${percent}%)`;
                } else {
                    expectedItemEl.textContent = 'Expected: None (0%)';
                }
            } else {
                expectedItemEl.textContent = 'Expected: None (Add 3+ ores)';
                highestProbabilityItem = null;
            }
        }

        function showVariantTooltip(itemName, event) {
            const tooltip = document.getElementById('variant-tooltip');
            const tooltipTitle = document.getElementById('tooltip-item-name');
            const tooltipContent = document.getElementById('tooltip-content');

            const variants = specificItemVariants[currentMode]?.[itemName]?.[currentArea];

            if (!variants || variants.length === 0) {
                tooltipContent.innerHTML = `<p>No specific variants available for ${itemName} in ${currentArea === 'kingdom' ? 'Forgotten Kingdom' : 'Stonewake\'s Cross'}.</p>`;
            } else {
                let html = `<p style="margin-bottom: 10px; color: var(--text-secondary);">Available in ${currentArea === 'kingdom' ? 'Forgotten Kingdom' : 'Stonewake\'s Cross'}:</p>`;
                html += '<ul class="variant-list">';

                variants.forEach(variant => {
                    const areaExclusive = variant.name.includes('[') ? variant.name.match(/\[(.*?)\]/)?.[1] : null;
                    const cleanName = variant.name.replace(/\s*\[.*?\]\s*/, '');

                    html += `
                <li class="variant-item">
                    <div>
                        <div class="variant-name">${cleanName}</div>
                        ${areaExclusive ? `<div class="area-exclusive">Exclusive to ${areaExclusive}</div>` : ''}
                    </div>
                    <div class="variant-chance">${variant.chance}</div>
                </li>
            `;
                });

                html += '</ul>';
                tooltipContent.innerHTML = html;
            }

            tooltipTitle.textContent = `${itemName} Variants`;

            positionTooltip(tooltip, event);

            tooltip.style.display = 'block';
        }

        function positionTooltip(tooltip, event) {
            tooltip.style.display = 'block';
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            const clickX = event.clientX;
            const clickY = event.clientY;

            let top = clickY + 10;
            let left = clickX;

            if (left + tooltipRect.width > viewportWidth - 10) {
                left = viewportWidth - tooltipRect.width - 10;
            }

            if (left < 10) {
                left = 10;
            }

            if (top + tooltipRect.height > viewportHeight - 10) {
                top = clickY - tooltipRect.height - 10;

                if (top < 10) {
                    top = viewportHeight - tooltipRect.height - 10;
                }
            }

            if (top < 10) {
                top = 10;
            }

            tooltip.style.position = 'fixed';
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.style.transform = 'none';
        }

        function updateAreaToggle() {
            const areaToggle = document.getElementById('area-toggle-btn');
            const areaLabel = document.getElementById('area-label');

            function applyAreaClasses() {
                areaLabel.textContent = currentArea === 'kingdom' ? 'Forgotten Kingdom' : 'Stonewake\'s Cross';
                areaToggle.classList.toggle('kingdom', currentArea === 'kingdom');
                areaToggle.classList.toggle('stonewake', currentArea === 'stonewake');
            }

            applyAreaClasses();

            areaToggle.addEventListener('click', () => {
                currentArea = currentArea === 'kingdom' ? 'stonewake' : 'kingdom';
                applyAreaClasses();

                updateProbabilities();
                updateExpectedItem();
            });
        }

        function renderOreInventory() {
            oreInventory.innerHTML = '';

            let filteredOres = oreData;

            if (activeFilter !== 'all') {
                if (activeFilter === 'has-trait') {
                    filteredOres = oreData.filter(ore => ore.traits.some(trait => trait.type === 'weapon' || trait.type === 'all' || trait.type === 'armor'));
                }

                else if (activeFilter === 'has-weapon-trait') {
                    filteredOres = oreData.filter(ore => ore.traits.some(trait => trait.type === 'weapon' || trait.type === 'all'));
                }

                else if (activeFilter === 'has-armor-trait') {
                    filteredOres = oreData.filter(ore => ore.traits.some(trait => trait.type === 'armor' || trait.type === 'all'));
                }
                else {
                    filteredOres = oreData.filter(ore => ore.area === activeFilter);
                }
            }

            filteredOres.forEach(ore => {
                const oreElement = document.createElement('div');
                oreElement.className = `ore-item ${ore.rarity} ${ore.traits.length > 0 ? 'has-trait' : ''}`;
                oreElement.dataset.id = ore.id;

                if (oreImages[ore.name]) {
                    oreElement.style.backgroundImage = `url('${oreImages[ore.name]}')`;
                } else {
                    oreElement.classList.add('no-image');
                    oreElement.innerHTML = `<i class="fas fa-gem" style="color: ${ore.color}; font-size: 40px; margin-bottom: 10px;"></i>`;
                }

                oreElement.innerHTML = `
    ${ore.traits.length > 0 ? '<div class="trait-indicator"><i class="fas fa-magic"></i></div>' : ''}
    ${!oreImages[ore.name] ? `<div class="ore-icon"><i class="fas fa-gem" style="color: ${ore.color};"></i></div>` : ''}
    <div class="ore-name">${ore.name}</div>
    <div class="ore-multiplier">${ore.multiplier}x</div>
`;

                oreElement.addEventListener('click', () => addOreToMix(ore.id));
                oreInventory.appendChild(oreElement);
            });
        }

        function addOreToMix(oreId) {
            const uniqueOres = oreMix.map(item => item.id);
            const oreIndex = uniqueOres.indexOf(oreId);

            if (oreIndex === -1 && uniqueOres.length >= 4) {
                return;
            }

            if (oreIndex === -1) {
                oreMix.push({ id: oreId, count: 1 });
            } else {
                oreMix[oreIndex].count++;
            }

            updateOreSlots();
            updateProbabilities();
        }

        function removeOreFromMix(oreId) {
            const oreIndex = oreMix.findIndex(item => item.id === oreId);

            if (oreIndex !== -1) {
                if (oreMix[oreIndex].count > 1) {
                    oreMix[oreIndex].count--;
                } else {
                    oreMix.splice(oreIndex, 1);
                }
            }

            updateOreSlots();
            updateProbabilities();
        }

        function updateOreSlots() {
            const slots = document.querySelectorAll('.slot');
            let totalOres = 0;
            let uniqueOres = oreMix.length;

            let multiplierSum = 0;
            oreMix.forEach(item => {
                const ore = oreData.find(o => o.id === item.id);
                totalOres += item.count;
                multiplierSum += ore.multiplier * item.count;
            });

            const multiplier = totalOres > 0 ? (multiplierSum / totalOres).toFixed(2) : 0;

            multiplierValue.textContent = `Multiplier: ${multiplier}x`;

            slots.forEach(slot => {
                slot.innerHTML = '<div class="slot-placeholder">Empty slot</div>';
                slot.classList.remove('filled');
            });

            oreMix.forEach((item, index) => {
                if (index >= 4) return;

                const ore = oreData.find(o => o.id === item.id);
                const slot = slots[index];
                const percentage = totalOres > 0 ? ((item.count / totalOres) * 100).toFixed(1) : 0;

                let backgroundStyle = '';
                if (oreImages[ore.name]) {
                    backgroundStyle = `style="background-image: url('${oreImages[ore.name]}')"`;
                }

                slot.innerHTML = `
                    <div class="slot-ore" ${backgroundStyle} data-id="${ore.id}">
                        ${!oreImages[ore.name] ? `<i class="fas fa-gem" style="color: ${ore.color}; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>` : ''}
                        <div class="slot-ore-name">${ore.name}</div>
                        <div class="slot-ore-count">${item.count}</div>
                        <div class="slot-ore-percentage">${percentage}%</div>
                    </div>
                `;
                slot.classList.add('filled');

                slot.querySelector('.slot-ore').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeOreFromMix(ore.id);
                });
            });

            updateActiveTraits(totalOres);
            updateExpectedItem();
        }

        function updateActiveTraits(totalOres) {
            activeTraitsContainer.innerHTML = '';

            if (oreMix.length === 0) {
                activeTraitsContainer.innerHTML = '<div class="trait-placeholder">Add ores with traits to see effects...</div>';
                return;
            }

            const traitsList = [];

            oreMix.forEach(item => {
                const ore = oreData.find(o => o.id === item.id);
                const percentage = (item.count / totalOres) * 100;

                if (ore.traits && ore.traits.length > 0 && percentage >= 10) {
                    ore.traits.forEach(trait => {
                        const isApplicable = trait.type === 'all' || trait.type === currentMode;

                        if (isApplicable) {
                            let scaledValues = {};
                            Object.keys(trait.scaling).forEach(key => {
                                const scale = trait.scaling[key];
                                let value = 0;

                                if (percentage >= 30) {
                                    value = scale.max;
                                } else if (percentage >= 10) {
                                    const scaleFactor = (percentage - 10) / 20;
                                    value = scale.min + (scale.max - scale.min) * scaleFactor;
                                }

                                scaledValues[key] = Math.round(value * 10) / 10;
                            });

                            let formattedDesc = trait.description;
                            Object.keys(scaledValues).forEach(key => {
                                formattedDesc = formattedDesc.replace(`{${key}}`, scaledValues[key]);
                            });

                            traitsList.push({
                                oreName: ore.name,
                                description: formattedDesc,
                                percentage: percentage,
                                oreId: ore.id,
                                rawDescription: trait.description
                            });
                        }
                    });
                }
            });

            if (traitsList.length === 0) {
                activeTraitsContainer.innerHTML = '<div class="trait-placeholder">No active traits (need at least 10% of an ore with traits)</div>';
                return;
            }

            traitsList.forEach(traitInfo => {
                const traitElement = document.createElement('div');
                traitElement.className = 'trait-card';
                traitElement.dataset.oreId = traitInfo.oreId;
                traitElement.dataset.percentage = traitInfo.percentage.toFixed(1);

                traitElement.innerHTML = `
                    <div class="trait-content">
                        <div class="trait-name">
                            ${traitInfo.oreName}
                            <span class="trait-percentage">${traitInfo.percentage.toFixed(1)}%</span>
                        </div>
                        <div class="trait-description">${traitInfo.description}</div>
                    </div>
        `;

                activeTraitsContainer.appendChild(traitElement);
            });
        }

        function updateProbabilities() {
            probabilityList.innerHTML = '';

            const totalOres = oreMix.reduce((sum, item) => sum + item.count, 0);
            const probabilities = currentMode === 'weapon' ? weaponProbabilities : armorProbabilities;
            const optimal = currentMode === 'weapon' ? optimalCounts.weapon : optimalCounts.armor;

            let closestCount = 3;
            if (totalOres >= 50) {
                closestCount = 50;
            } else if (totalOres >= 3) {
                const counts = Object.keys(probabilities).map(Number);
                closestCount = counts.reduce((prev, curr) => {
                    return (Math.abs(curr - totalOres) < Math.abs(prev - totalOres) ? curr : prev);
                });
            }

            const currentProbs = probabilities[closestCount] || {};

            Object.entries(currentProbs).forEach(([itemName, probability]) => {
                const probabilityPercent = (probability * 100).toFixed(1);

                const itemElement = document.createElement('div');
                itemElement.className = 'probability-item';
                itemElement.dataset.itemName = itemName;

                itemElement.innerHTML = `
    <div class="item-header">
        <div class="item-name">${itemName}</div>
        <div class="optimal-count">${optimal[itemName] || 'N/A'}</div>
    </div>
    <div class="probability-bar">
        <div class="probability-fill" style="width: ${probabilityPercent}%"></div>
        <div class="probability-value">${probabilityPercent}%</div>
    </div>
`;

                itemElement.addEventListener('click', (e) => {
                    showVariantTooltip(itemName, e);
                    e.stopPropagation();
                });

                itemElement.addEventListener('mouseenter', () => {
                    itemElement.style.cursor = 'pointer';
                });

                probabilityList.appendChild(itemElement);
            });

            if (totalOres < 3) {
                probabilityList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Add at least 3 ores to see forge chances</p>
                    </div>
                `;
            }
        }

        function setupQuickCraft() {
            quickCraftBtn.addEventListener('click', () => {
                quickCraftModal.style.display = 'flex';
                setTimeout(() => quickCraftModal.classList.add('show'), 10);

                if (window.innerWidth <= 480) {
                    document.body.classList.add('modal-open');
                }

                resetQuickCraft();
                showStep(0);
                setTimeout(() => quickCraftModal.focus(), 10);
            });

            modalClose.addEventListener('click', () => {
                resetQuickCraft();
                quickCraftModal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    quickCraftModal.style.display = 'none';
                    quickCraftModal.classList.remove('show');
                    quickCraftModal.style.animation = '';
                    document.body.classList.remove('modal-open');
                }, 300);
                resetQuickCraft();
            });

            quickCraftModal.addEventListener('click', (e) => {
                if (e.target === quickCraftModal) {
                    resetQuickCraft();
                    quickCraftModal.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        quickCraftModal.style.display = 'none';
                        quickCraftModal.classList.remove('show');
                        quickCraftModal.style.animation = '';
                        document.body.classList.remove('modal-open');
                    }, 300);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && quickCraftModal.style.display === 'flex') {
                    resetQuickCraft();
                    quickCraftModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }
            });

            if (window.innerWidth <= 480) {
                quickCraftModal.addEventListener('wheel', (e) => {
                    const modalContent = document.querySelector('.modal-content');
                    const atTop = modalContent.scrollTop === 0;
                    const atBottom = modalContent.scrollHeight - modalContent.scrollTop === modalContent.clientHeight;

                    if ((e.deltaY < 0 && atTop) || (e.deltaY > 0 && atBottom)) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }, { passive: false });
            }

            quickCraftModal.addEventListener('touchmove', (e) => {
                if (e.target === quickCraftModal || e.target.closest('.modal-content')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    showStep(currentStep - 1);
                }
            });

            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    if (currentStep < 3) {
                        showStep(currentStep + 1);
                    }
                }
            });

            craftBtn.addEventListener('click', () => {
                applyQuickCraft();

                quickCraftModal.style.animation = 'fadeOut .3s ease';
                setTimeout(() => {
                    quickCraftModal.style.display = 'none';
                    quickCraftModal.classList.remove('show');
                    quickCraftModal.style.animation = '';
                    document.body.classList.remove('modal-open');
                }, 300);
                resetSteps();
            });

            document.querySelectorAll('.modal-option[data-type]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.modal-option[data-type]').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    quickCraftType = option.dataset.type;
                });
            });
        }

        function resetSteps() {
            [stepType, stepItem, stepTraits, stepSummary].forEach(s => {
                s.classList.remove('active', 'step-anim-in', 'step-anim-out');
            });
        }

        function showStep(step) {
            const steps = [stepType, stepItem, stepTraits, stepSummary];

            const previous = steps[currentStep];
            const next = steps[step];

            if (previous && previous !== next) {
                previous.classList.remove('active');
                previous.classList.add('step-anim-out');

                setTimeout(() => {
                    previous.classList.remove('step-anim-out');
                }, 300);
            }

            next.classList.add('active', 'step-anim-in');
            setTimeout(() => next.classList.remove('step-anim-in'), 300);

            currentStep = step;

            prevBtn.style.display = step === 0 ? 'none' : 'inline-block';
            nextBtn.style.display = step < 3 ? 'inline-block' : 'none';
            craftBtn.style.display = step === 3 ? 'inline-block' : 'none';

            switch (step) {
                case 1: loadItemOptions(); break;
                case 2: loadTraitOptions(); break;
                case 3: loadSummary(); break;
            }
        }

        function validateStep(step) {
            switch (step) {
                case 0:
                    if (!quickCraftType) {
                        return false;
                    }
                    return true;
                case 1:
                    if (!quickCraftItem) {
                        return false;
                    }
                    return true;
                case 2:
                    if (selectedTraits.length === 0) {

                        return false;

                    }
                    return true;
                default:
                    return true;
            }
        }

        function loadItemOptions() {
            itemOptions.innerHTML = '';
            const items = quickCraftType === 'weapon' ? optimalCounts.weapon : optimalCounts.armor;
            if (quickCraftType !== currentMode) {
                currentMode = quickCraftType;
                if (currentMode === 'weapon') {
                    weaponToggle.classList.add('active');
                    armorToggle.classList.remove('active');
                    applyColorScheme(weaponColors);
                } else {
                    armorToggle.classList.add('active');
                    weaponToggle.classList.remove('active');
                    applyColorScheme(armorColors);
                }
                updateProbabilities();
            }

            Object.entries(items).forEach(([itemName, optimalCount]) => {
                const option = document.createElement('div');
                option.className = 'modal-option';
                option.dataset.item = itemName;
                option.innerHTML = `
                    <div style="font-weight: bold; font-size: 0.9rem;">${itemName}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Optimal: ${optimalCount} ores</div>
                `;

                option.addEventListener('click', () => {
                    document.querySelectorAll('.modal-option[data-item]').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    quickCraftItem = {
                        name: itemName,
                        optimal: optimalCount
                    };
                });

                itemOptions.appendChild(option);
            });
        }

        function loadTraitOptions() {
            traitOptions.innerHTML = '';
            selectedTraits = [];

            const availableTraits = oreData.filter(ore =>
                ore.traits.length > 0 &&
                ore.traits.some(trait => trait.type === 'all' || trait.type === quickCraftType)
            );

            availableTraits.forEach(ore => {
                ore.traits.forEach(trait => {
                    if (trait.type === 'all' || trait.type === quickCraftType) {
                        const option = document.createElement('div');
                        option.className = 'trait-option';
                        option.dataset.oreId = ore.id;

                        let desc = trait.description;
                        Object.keys(trait.scaling).forEach(key => {
                            const scale = trait.scaling[key];
                            desc = desc.replace(`{${key}}`, `${scale.min}-${scale.max}`);
                        });

                        option.innerHTML = `
                    <div class="trait-info">
                        <div class="trait-name">${ore.name} (${ore.multiplier}x)</div>
                        <div class="trait-desc">${desc}</div>
                    </div>
                `;

                        option.addEventListener('click', () => {
                            const isSelected = option.classList.contains('selected');

                            if (!isSelected) {
                                if (selectedTraits.length >= 4) {
                                    return;
                                }

                                selectedTraits.push({
                                    oreId: ore.id,
                                    oreName: ore.name,
                                    description: trait.description,
                                    scaling: trait.scaling
                                });
                                option.classList.add('selected');
                            } else {
                                selectedTraits = selectedTraits.filter(t => t.oreId !== ore.id);
                                option.classList.remove('selected');
                            }

                            updateSelectedTraitsCount();
                        });

                        traitOptions.appendChild(option);
                    }
                });
            });

            updateSelectedTraitsCount();
        }

        function updateSelectedTraitsCount() {
            selectedTraitsCount.textContent = `Selected: ${selectedTraits.length}/4 traits`;
        }

        function loadSummary() {
            const optimalCount = quickCraftItem.optimal;
            let mixPlan = [];

            if (selectedTraits.length === 0) {
                mixPlan = [{ id: 1, count: optimalCount }];
            } else {

                const traitCount = selectedTraits.length;
                selectedTraits.forEach(trait => {
                    mixPlan.push({
                        id: trait.oreId,
                        count: 1
                    });
                });

                let totalOres = traitCount;
                const remainingOres = optimalCount - traitCount;

                if (remainingOres > 0) {
                    const baseAddition = Math.floor(remainingOres / traitCount);
                    const extraOres = remainingOres % traitCount;

                    mixPlan.forEach((item, index) => {
                        item.count += baseAddition;
                    });

                    for (let i = 0; i < extraOres; i++) {
                        mixPlan[i].count++;
                    }
                }

                totalOres = mixPlan.reduce((sum, item) => sum + item.count, 0);

                if (totalOres < optimalCount) {
                    const shortfall = optimalCount - totalOres;

                    for (let i = 0; i < shortfall; i++) {
                        const traitIndex = i % traitCount;
                        mixPlan[traitIndex].count++;
                    }
                }

                totalOres = mixPlan.reduce((sum, item) => sum + item.count, 0);
                if (totalOres > optimalCount) {
                    const excess = totalOres - optimalCount;
                    mixPlan[mixPlan.length - 1].count -= excess;
                }
            }

            let summaryHTML = `
                <div class="forge-result-container" style="margin-bottom: 20px; background: var(--primary-light);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-hammer" style="font-size: 1.5rem; color: var(--primary);"></i>
                        <div>
                            <div style="font-weight: bold; font-size: 1.2rem;">${quickCraftItem.name}</div>
                            <div style="color: var(--text-secondary);">${quickCraftType === 'weapon' ? 'Weapon' : 'Armor'}  Optimal: ${optimalCount} ores</div>
                        </div>
                    </div>
            `;

            if (selectedTraits.length > 0) {
                summaryHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">Selected Traits:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                `;

                selectedTraits.forEach(trait => {
                    summaryHTML += `
                        <div style="background: var(--primary-light); border: 1px solid var(--primary); border-radius: var(--border-radius); padding: 5px 12px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-magic" style="color: var(--primary);"></i>
                            ${trait.oreName}
                        </div>
                    `;
                });

                summaryHTML += `</div></div>`;
            }

            summaryHTML += `
                    <div>
                        <div style="font-weight: bold; margin-bottom: 10px;">Ore Mix:</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
            `;

            const totalOresInMix = mixPlan.reduce((sum, item) => sum + item.count, 0);
            const multiplierSum = mixPlan.reduce((sum, item) => {
                const ore = oreData.find(o => o.id === item.id);
                return sum + (ore.multiplier * item.count);
            }, 0);
            const avgMultiplier = (multiplierSum / totalOresInMix).toFixed(2);

            mixPlan.forEach(item => {
                const ore = oreData.find(o => o.id === item.id);
                const percentage = ((item.count / totalOresInMix) * 100).toFixed(1);
                summaryHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: var(--border-radius);">
                        <div>
                            <div style="font-weight: bold;">${ore.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text);">${ore.multiplier}x multiplier</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold;">${item.count}x (${percentage}%)</div>
                        </div>
                    </div>
                `;
            });

            summaryHTML += `
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: var(--primary-light); border-radius: var(--border-radius); text-align: center;">
                            <i class="fas fa-calculator"></i> Total: ${totalOresInMix} ores  Avg Multiplier: ${avgMultiplier}x
                        </div>
                    </div>
                </div>
            `;

            summaryContent.innerHTML = summaryHTML;

            summaryContent.dataset.mixPlan = JSON.stringify(mixPlan);
        }

        function applyQuickCraft() {
            const mixPlan = JSON.parse(summaryContent.dataset.mixPlan);

            if (quickCraftType !== currentMode) {
                currentMode = quickCraftType;
                if (currentMode === 'weapon') {
                    weaponToggle.classList.add('active');
                    armorToggle.classList.remove('active');
                    applyColorScheme(weaponColors);
                } else {
                    armorToggle.classList.add('active');
                    weaponToggle.classList.remove('active');
                    applyColorScheme(armorColors);
                }
                updateProbabilities();
            }

            oreMix = [];
            mixPlan.forEach(item => {
                const existingIndex = oreMix.findIndex(ore => ore.id === item.id);
                if (existingIndex !== -1) {
                    oreMix[existingIndex].count += item.count;
                } else {
                    oreMix.push({ id: item.id, count: item.count });
                }
            });

            updateOreSlots();
            if (quickCraftType === currentMode) {
                updateProbabilities();
            }

            quickCraftModal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function resetQuickCraft() {
            quickCraftType = null;
            quickCraftItem = null;
            selectedTraits = [];
            currentStep = 0;

            document.querySelectorAll('.modal-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.trait-checkbox').forEach(cb => cb.checked = false);

            [stepType, stepItem, stepTraits, stepSummary].forEach(step => {
                step.classList.remove('active', 'step-anim-in', 'step-anim-out');
            });

            stepType.classList.add('active');
        }

        function getVariantProbabilities(variants) {
            if (!variants || variants.length === 0) {
                return null;
            }

            const weights = variants.map(v => {
                const [num, den] = v.chance.split('/').map(Number);
                return num / den;
            });

            const total = weights.reduce((a, b) => a + b, 0);
            return variants.map((v, i) => ({
                ...v,
                normalizedProb: weights[i] / total
            }));
        }

        function getRandomVariant(itemType) {
            const variants = specificItemVariants[currentMode]?.[itemType]?.[currentArea];
            if (!variants || variants.length === 0) {
                return { name: itemType, chance: "1/1", probability: 1.0 };
            }

            const weightedVariants = getVariantProbabilities(variants);
            if (!weightedVariants) return { name: itemType, chance: "1/1", probability: 1.0 };

            let random = Math.random();
            let cumulative = 0;

            for (const variant of weightedVariants) {
                cumulative += variant.normalizedProb;
                if (random <= cumulative) {
                    return variant;
                }
            }

            return weightedVariants[0];
        }

        function getMainOre() {
            if (oreMix.length === 0) return null;

            let maxCount = 0;
            let mainOre = null;

            oreMix.forEach(item => {
                if (item.count > maxCount) {
                    maxCount = item.count;
                    const ore = oreData.find(o => o.id === item.id);
                    mainOre = ore;
                }
            });

            const ties = oreMix.filter(item => item.count === maxCount);
            if (ties.length > 1) {
                ties.sort((a, b) => {
                    const oreA = oreData.find(o => o.id === a.id);
                    const oreB = oreData.find(o => o.id === b.id);
                    return oreB.multiplier - oreA.multiplier;
                });
                mainOre = oreData.find(o => o.id === ties[0].id);
            }

            return mainOre;
        }

        function calculateScaledStats(itemName, multiplier) {
            const stats = baseItemStats[currentMode][itemName];
            if (!stats) return null;

            const scaled = { ...stats };

            if (currentMode === 'weapon') {
                scaled.damage = stats.damage * multiplier;
                scaled.price = stats.price * multiplier;
            } else {
                scaled.def = stats.def * multiplier;
                scaled.price = stats.price * multiplier;
            }

            return scaled;
        }

        function getActiveTraits() {
            const totalOres = oreMix.reduce((sum, item) => sum + item.count, 0);
            const traitsList = [];

            oreMix.forEach(item => {
                const ore = oreData.find(o => o.id === item.id);
                const percentage = (item.count / totalOres) * 100;

                if (ore.traits && ore.traits.length > 0 && percentage >= 10) {
                    ore.traits.forEach(trait => {
                        const isApplicable = trait.type === 'all' || trait.type === currentMode;

                        if (isApplicable) {
                            let scaledValues = {};
                            Object.keys(trait.scaling).forEach(key => {
                                const scale = trait.scaling[key];
                                let value = 0;

                                if (percentage >= 30) {
                                    value = scale.max;
                                } else if (percentage >= 10) {
                                    const scaleFactor = (percentage - 10) / 20;
                                    value = scale.min + (scale.max - scale.min) * scaleFactor;
                                }

                                scaledValues[key] = Math.round(value * 10) / 10;
                            });

                            let formattedDesc = trait.description;
                            Object.keys(scaledValues).forEach(key => {
                                formattedDesc = formattedDesc.replace(`{${key}}`, scaledValues[key]);
                            });

                            traitsList.push({
                                oreName: ore.name,
                                description: formattedDesc,
                                percentage: percentage,
                                oreColor: ore.color
                            });
                        }
                    });
                }
            });

            return traitsList;
        }

        function simulateForge() {
            const totalOres = oreMix.reduce((sum, item) => sum + item.count, 0);

            if (totalOres < 3) {
                return;
            }

            const forgeBtn = document.getElementById('forge-btn');
            const originalText = forgeBtn.innerHTML;
            forgeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Forging...';
            forgeBtn.disabled = true;

            let multiplierSum = 0;
            oreMix.forEach(item => {
                const ore = oreData.find(o => o.id === item.id);
                multiplierSum += ore.multiplier * item.count;
            });
            const multiplier = multiplierSum / totalOres;

            const probabilities = currentMode === 'weapon' ? weaponProbabilities : armorProbabilities;
            const counts = Object.keys(probabilities).map(Number);
            const closestCount = counts.reduce((prev, curr) => {
                return (Math.abs(curr - totalOres) < Math.abs(prev - totalOres) ? curr : prev);
            });

            const currentProbs = probabilities[closestCount] || {};

            let random = Math.random();
            let selectedItemType = null;
            let cumulativeProb = 0;

            for (const [itemType, prob] of Object.entries(currentProbs)) {
                cumulativeProb += prob;
                if (random <= cumulativeProb) {
                    selectedItemType = itemType;
                    break;
                }
            }

            if (!selectedItemType) {
                selectedItemType = Object.keys(currentProbs)[0];
            }

            const variant = getRandomVariant(selectedItemType);
            const itemName = variant.name.replace(/\s*\[.*?\]\s*/g, '');

            const mainOre = getMainOre();

            const scaledStats = calculateScaledStats(itemName, multiplier);

            const activeTraits = getActiveTraits();

            setTimeout(() => {
                showForgeResult({
                    itemName: itemName,
                    itemType: selectedItemType,
                    variant: variant,
                    multiplier: multiplier,
                    mainOre: mainOre,
                    stats: scaledStats,
                    traits: activeTraits,
                    area: currentArea,
                    totalOres: totalOres
                });

                forgeBtn.innerHTML = originalText;
                forgeBtn.disabled = false;
            }, 300);
        }


        function showForgeResult(result) {
            const modal = document.getElementById('forge-result-modal');
            const content = document.getElementById('forge-result-body');

            const bgColor = result.mainOre ? result.mainOre.color : '#FF6600';
            const areaBgColor = currentArea === 'kingdom' ? 'var(--primary-light)' : 'rgba(8,78,78,0.2)';
            const areaColor = currentArea === 'kingdom' ? 'var(--primary)' : 'var(--stonewake-teal)';

            const itemImage = itemImages[result.itemName] || '';

            content.innerHTML = `
        <div class="forge-result-container" style="background: linear-gradient(135deg, ${bgColor}15 0%, ${bgColor}08 25%, rgba(0,0,0,0.1) 50%, ${bgColor}08 75%, ${bgColor}15 100%); border: 2px solid ${bgColor}40;">
            <div class="forge-result-header">
                ${itemImage ? `
                    <div class="forge-result-image" style="background-image: url('${itemImage}'); border-color: ${bgColor}; box-shadow: 0 0 25px ${bgColor}80;">
                    </div>
                ` : ''}
                <div class="forge-result-details">
                    <div class="forge-result-name" style="color: ${bgColor};">
                        ${result.itemName}
                    </div>
                    <div class="forge-result-type">
                        ${result.itemType}  ${result.mainOre?.rarity ? result.mainOre.rarity.charAt(0).toUpperCase() + result.mainOre.rarity.slice(1) : 'Common'}
                    </div>
                    <div class="forge-result-tags">
                        <div class="forge-tag" style="background: var(--primary-light); color: var(--primary);">
                            <i class="fas fa-percent"></i> ${result.multiplier.toFixed(2)}x Multi
                        </div>
                        <div class="forge-tag" style="background: var(--primary-light); color: var(--primary);">
                            <i class="fas fa-star"></i> [100]% Masterwork
                        </div>
                        <div class="forge-tag" style="background: ${bgColor}30; color: ${bgColor};">
                            <i class="fas fa-gem"></i> ${result.mainOre?.name || 'Stone'}
                        </div>
                        <div class="forge-tag" style="background: ${areaBgColor}; color: ${areaColor};">
                            <i class="fas fa-map-marker-alt"></i> ${currentArea === 'kingdom' ? 'Forgotten Kingdom' : 'Stonewake\'s Cross'}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="forge-stats-grid">
                ${currentMode === 'weapon' ? `
                    <div class="forge-stat-item">
                        <div class="forge-stat-value">${result.stats.damage.toFixed(2)}</div>
                        <div class="forge-stat-label">DAMAGE</div>
                    </div>
                    <div class="forge-stat-item">
                        <div class="forge-stat-value">${result.stats.atkSpeed}s</div>
                        <div class="forge-stat-label">ATK SPEED</div>
                    </div>
                    <div class="forge-stat-item">
                        <div class="forge-stat-value">${result.stats.range} studs</div>
                        <div class="forge-stat-label">RANGE</div>
                    </div>
                    <div class="forge-stat-item">
                        <div class="forge-stat-value">$${Math.round(result.stats.price)}</div>
                        <div class="forge-stat-label">VALUE</div>
                    </div>
                ` : `
                    <div class="forge-stat-item">
                        <div class="forge-stat-value">+${result.stats.health}%</div>
                        <div class="forge-stat-label">HEALTH BONUS</div>
                    </div>
                    <div class="forge-stat-item">
                        <div class="forge-stat-value">${Math.round(result.stats.def)}</div>
                        <div class="forge-stat-label">DEF</div>
                    </div>
                    <div class="forge-stat-item" style="grid-column: 1 / -1;">
                        <div class="forge-stat-value">$${Math.round(result.stats.price)}</div>
                        <div class="forge-stat-label">VALUE</div>
                    </div>
                `}
            </div>
            
            ${result.traits.length > 0 ? `
                <div class="traits-section">
                    <div class="section-title">
                        <span><i class="fas fa-magic"></i> Item Traits</span>
                    </div>
                    <div class="traits-list-container">
                        ${result.traits.map(trait => `
                            <div class="forge-trait-item" style="border-color: ${trait.oreColor || 'var(--primary)'}40;">
                                <div class="forge-trait-ore" style="color: ${trait.oreColor || 'var(--primary)'};">
                                    <i class="fas fa-gem"></i> ${trait.oreName} (${trait.percentage.toFixed(1)}%)
                                </div>
                                <div class="forge-trait-desc">
                                    ${trait.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

        </div>
    `;

            modal.style.display = 'flex';
            modal.classList.add('show');
            if (window.innerWidth <= 480) {
                document.body.classList.add('modal-open');
            }
        }

        function setupForgeResultModal() {
            const modal = document.getElementById('forge-result-modal');
            const closeBtn = document.getElementById('forge-result-close');
            const closeResultBtn = document.getElementById('close-result-btn');
            const forgeAgainBtn = document.getElementById('forge-again-btn');

            function closeModal() {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    modal.style.animation = '';
                    document.body.classList.remove('modal-open');
                }, 300);
            }

            closeBtn.addEventListener('click', closeModal);
            closeResultBtn.addEventListener('click', closeModal);

            forgeAgainBtn.addEventListener('click', () => {
                closeModal();
                setTimeout(() => simulateForge(), 350);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        const weaponColors = {
            '--primary': '#FF6600',
            '--primary-dark': '#cc5200',
            '--primary-light': 'rgba(255, 102, 0, 0.1)',
            '--primary-glow': 'rgba(255, 102, 0, 0.3)',
            '--text-secondary': '#ffa366',
            '--glow': '0 0 20px rgba(255, 102, 0, 0.4)'
        };

        const armorColors = {
            '--primary': '#1da5a5',
            '--primary-dark': '#0a6e6e',
            '--primary-light': 'rgba(13, 165, 165, 0.1)',
            '--primary-glow': 'rgba(13, 165, 165, 0.3)',
            '--text-secondary': '#6fdcdc',
            '--glow': '0 0 20px rgba(13, 165, 165, 0.4)'
        };

        function applyColorScheme(colors) {
            const root = document.documentElement;
            Object.keys(colors).forEach(key => {
                root.style.setProperty(key, colors[key]);
            });
        }

        function setupEventListeners() {
            weaponToggle.addEventListener('click', () => {
                currentMode = 'weapon';
                weaponToggle.classList.add('active');
                armorToggle.classList.remove('active');
                applyColorScheme(weaponColors);
                updateProbabilities();
                updateExpectedItem();
                updateActiveTraits(oreMix.reduce((sum, item) => sum + item.count, 0));
            });

            armorToggle.addEventListener('click', () => {
                currentMode = 'armor';
                armorToggle.classList.add('active');
                weaponToggle.classList.remove('active');
                applyColorScheme(armorColors);
                updateProbabilities();
                updateExpectedItem();
                updateActiveTraits(oreMix.reduce((sum, item) => sum + item.count, 0));
            });

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeFilter = btn.dataset.filter;
                    renderOreInventory();
                });
            });

            resetBtn.addEventListener('click', () => {
                oreMix = [];
                updateOreSlots();
                updateProbabilities();
            });

            const forgeBtn = document.getElementById('forge-btn');
            if (forgeBtn) {
                forgeBtn.addEventListener('click', simulateForge);
            }

        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
